# ─── AgentBox Docker Compose ─────────────────────────────────────────────────
# Security-hardened configuration.
# See SECURITY.md and UPGRADE.md for operational guidance.
#
# Quick start:
#   ANTHROPIC_API_KEY=sk-ant-... docker compose up -d
#
# To rebuild with a specific OpenClaw version:
#   OPENCLAW_VERSION=2026.X.Y docker compose build
# ─────────────────────────────────────────────────────────────────────────────

services:
  agentbox:
    build:
      context: .
      args:
        # Pin the OpenClaw version at build time. Override to test a new release:
        #   OPENCLAW_VERSION=2026.X.Y docker compose build
        # See UPGRADE.md before bumping.
        OPENCLAW_VERSION: ${OPENCLAW_VERSION:-2026.2.15}
    image: agentbox:latest
    container_name: agentbox
    hostname: agentbox

    # ── Runtime security hardening ──────────────────────────────────────────
    security_opt:
      - no-new-privileges:true   # Prevents setuid/setgid escalation
      - seccomp=unconfined       # Replace with a custom seccomp profile in production

    # Drop ALL Linux capabilities; add back only what openclaw actually needs.
    # openclaw-gateway binds to port 3000 (>1024) so NET_BIND_SERVICE not needed.
    cap_drop:
      - ALL

    # Read-only root filesystem. Writable paths are mounted as tmpfs or volumes.
    read_only: true
    tmpfs:
      - /tmp:noexec,nosuid,nodev,size=256M
      - /run:noexec,nosuid,nodev,size=64M
      - /var/run/supervisor:noexec,nosuid,nodev,size=16M

    # ── Network ─────────────────────────────────────────────────────────────
    # Bind ONLY to localhost — never expose to 0.0.0.0
    ports:
      - "127.0.0.1:3000:3000"

    networks:
      - agentbox-net

    # ── Volumes ─────────────────────────────────────────────────────────────
    volumes:
      # Config and session state (read-write, persisted)
      - agentbox-config:/agentbox/.openclaw

      # Data directory (databases, caches)
      - agentbox-data:/agentbox/data

      # Logs — mount read-only on host if shipping elsewhere
      - agentbox-logs:/agentbox/logs

      # OpenClaw telemetry logs (shared with telemetry service)
      - openclaw-logs:/tmp/openclaw

      # Encrypted secrets — ALWAYS read-only in the container.
      # Uncomment after running: age-keygen -o secrets/agent.key
      # - ./secrets:/agentbox/secrets:ro

    # ── Environment variables ────────────────────────────────────────────────
    environment:
      - HOME=/agentbox
      - NODE_ENV=production
      - OPENCLAW_CONFIG_PATH=/agentbox/.openclaw/openclaw.json

      # Pass API keys from your host shell environment (never hardcode here).
      # Usage: export ANTHROPIC_API_KEY=sk-ant-... && docker compose up -d
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-}
      # - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      # - TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_TOKEN:-}

    # ── Resource limits ──────────────────────────────────────────────────────
    # Prevents runaway agent from exhausting host resources.
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 4G
        reservations:
          cpus: '0.5'
          memory: 512M

    # ── Reliability ─────────────────────────────────────────────────────────
    restart: unless-stopped

    healthcheck:
      test: ["CMD", "pgrep", "-f", "openclaw-gateway"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s

    # ── TTY (needed for interactive onboarding) ──────────────────────────────
    tty: true
    stdin_open: true

  # ── Telemetry Dashboard (optional) ────────────────────────────────────────
  telemetry:
    build: ./telemetry
    image: agentbox-telemetry:latest
    container_name: agentbox-telemetry
    hostname: telemetry

    security_opt:
      - no-new-privileges:true

    cap_drop:
      - ALL

    read_only: true
    tmpfs:
      - /tmp:noexec,nosuid,nodev,size=128M

    ports:
      - "127.0.0.1:8501:8501"

    networks:
      - agentbox-net

    # All mounts read-only — telemetry never writes to agent data
    # agentbox-config mounts at /data/openclaw so sessions are at /data/openclaw/agents/main/sessions
    volumes:
      - openclaw-logs:/tmp/openclaw:ro
      - agentbox-logs:/agentbox/logs:ro
      - agentbox-config:/data/openclaw:ro

    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 1G
        reservations:
          cpus: '0.25'
          memory: 256M

    environment:
      - OPENCLAW_SESSIONS_DIR=/data/openclaw/agents/main/sessions

    restart: unless-stopped

    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8501/_stcore/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s

    depends_on:
      - agentbox

# ── Networks ──────────────────────────────────────────────────────────────────
networks:
  agentbox-net:
    driver: bridge
    # Set internal: true to fully air-gap (blocks all internet access).
    # Only do this if you're using encrypted secrets pre-loaded at startup.
    internal: false

# ── Volumes ───────────────────────────────────────────────────────────────────
volumes:
  agentbox-config:
    driver: local
  agentbox-data:
    driver: local
  agentbox-logs:
    driver: local
  openclaw-logs:
    driver: local
